<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能数据指标理解 | 风若</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="工作笔记">
    
    <link rel="preload" href="/move-forward/assets/css/0.styles.22b8c465.css" as="style"><link rel="preload" href="/move-forward/assets/js/app.74813945.js" as="script"><link rel="preload" href="/move-forward/assets/js/2.613a331e.js" as="script"><link rel="preload" href="/move-forward/assets/js/37.0917cb31.js" as="script"><link rel="prefetch" href="/move-forward/assets/js/10.daa1ea11.js"><link rel="prefetch" href="/move-forward/assets/js/11.58c75502.js"><link rel="prefetch" href="/move-forward/assets/js/12.ead7f533.js"><link rel="prefetch" href="/move-forward/assets/js/13.3c09940b.js"><link rel="prefetch" href="/move-forward/assets/js/14.3dcc8a7d.js"><link rel="prefetch" href="/move-forward/assets/js/15.0476c0a1.js"><link rel="prefetch" href="/move-forward/assets/js/16.e15b14d6.js"><link rel="prefetch" href="/move-forward/assets/js/17.503f66d1.js"><link rel="prefetch" href="/move-forward/assets/js/18.7bce4343.js"><link rel="prefetch" href="/move-forward/assets/js/19.b55c92e8.js"><link rel="prefetch" href="/move-forward/assets/js/20.233fe781.js"><link rel="prefetch" href="/move-forward/assets/js/21.1d629ecf.js"><link rel="prefetch" href="/move-forward/assets/js/22.cd892e00.js"><link rel="prefetch" href="/move-forward/assets/js/23.dbf6d87b.js"><link rel="prefetch" href="/move-forward/assets/js/24.2343a437.js"><link rel="prefetch" href="/move-forward/assets/js/25.6dac1249.js"><link rel="prefetch" href="/move-forward/assets/js/26.1aa4afd6.js"><link rel="prefetch" href="/move-forward/assets/js/27.1da22353.js"><link rel="prefetch" href="/move-forward/assets/js/28.ca455340.js"><link rel="prefetch" href="/move-forward/assets/js/29.dc190ea9.js"><link rel="prefetch" href="/move-forward/assets/js/3.b374e5cc.js"><link rel="prefetch" href="/move-forward/assets/js/30.c8a2f0ab.js"><link rel="prefetch" href="/move-forward/assets/js/31.b233ab1f.js"><link rel="prefetch" href="/move-forward/assets/js/32.01e063f6.js"><link rel="prefetch" href="/move-forward/assets/js/33.fa790f01.js"><link rel="prefetch" href="/move-forward/assets/js/34.41ed631f.js"><link rel="prefetch" href="/move-forward/assets/js/35.cf568004.js"><link rel="prefetch" href="/move-forward/assets/js/36.b592747b.js"><link rel="prefetch" href="/move-forward/assets/js/38.2affb8de.js"><link rel="prefetch" href="/move-forward/assets/js/39.c4823457.js"><link rel="prefetch" href="/move-forward/assets/js/4.54d9ed54.js"><link rel="prefetch" href="/move-forward/assets/js/40.2434047f.js"><link rel="prefetch" href="/move-forward/assets/js/41.3df71466.js"><link rel="prefetch" href="/move-forward/assets/js/42.ba46f15a.js"><link rel="prefetch" href="/move-forward/assets/js/43.fa3c674a.js"><link rel="prefetch" href="/move-forward/assets/js/44.e9632703.js"><link rel="prefetch" href="/move-forward/assets/js/45.63d62eb2.js"><link rel="prefetch" href="/move-forward/assets/js/46.213f4952.js"><link rel="prefetch" href="/move-forward/assets/js/5.2d2a8cee.js"><link rel="prefetch" href="/move-forward/assets/js/6.1ffedd0f.js"><link rel="prefetch" href="/move-forward/assets/js/7.85d67591.js"><link rel="prefetch" href="/move-forward/assets/js/8.67e30446.js"><link rel="prefetch" href="/move-forward/assets/js/9.45924294.js">
    <link rel="stylesheet" href="/move-forward/assets/css/0.styles.22b8c465.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/move-forward/" class="home-link router-link-active"><img src="/move-forward/imgs/cat.jpeg" alt="风若" class="logo"> <span class="site-name can-hide">风若</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/move-forward/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/move-forward/summary/" class="nav-link">
  踩坑经验
</a></div><div class="nav-item"><a href="/move-forward/basement/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/HuangLotus/move-forward/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  踩坑issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/move-forward/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/move-forward/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/move-forward/summary/" class="nav-link">
  踩坑经验
</a></div><div class="nav-item"><a href="/move-forward/basement/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/HuangLotus/move-forward/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  踩坑issues
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/move-forward/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/move-forward/mynote" class="sidebar-heading clickable"><span>学习笔记</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/move-forward/mynote/异步任务串行执行的方法.html" class="sidebar-link">异步任务串行执行的方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/理解vue核心概念.html" class="sidebar-link">理解vue核心概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/对webpack热更新的理解.html" class="sidebar-link">对webpack热更新的理解</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/懒加载是如何实现的.html" class="sidebar-link">懒加载是如何实现的</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/对js模块的深入理解.html" class="sidebar-link">对js模块的深入理解</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/前端模块化如何实现换肤.html" class="sidebar-link">前端模块化如何实现换肤</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/mynote/如何解决定时器时间不准的问题.html" class="sidebar-link">如何解决定时器时间不准的问题</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/move-forward/performance" class="sidebar-heading clickable router-link-active open"><span>性能优化</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/move-forward/performance/性能数据指标理解.html" class="active sidebar-link">性能数据指标理解</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/performance/图片性能优化.html" class="sidebar-link">图片性能优化</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/move-forward/tools" class="sidebar-heading clickable"><span>工具开发</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/move-forward/mynote/chrome扩展开发总结.html" class="sidebar-link">chrome扩展开发总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/summary/如何实现一个简版的webpack.html" class="sidebar-link">如何实现一个简版的webpack</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/move-forward/platform" class="sidebar-heading clickable"><span>平台架构</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/move-forward/platform/如何规划一个node平台.html" class="sidebar-link">如何规划一个node平台</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/platform/如何部署mysql开发环境.html" class="sidebar-link">如何部署mysql环境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/move-forward/platform/本地部署mysql中遇到的问题.html" class="sidebar-link">本地部署mysql过程中遇到的问题</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><a href="/move-forward/first/新博客第一篇.html" class="sidebar-link">开始的话</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="性能数据指标理解"><a href="#性能数据指标理解" class="header-anchor">#</a> 性能数据指标理解</h3> <p>最近接触过IntersectionObserver和PerformanceObserver，对其总是理解不深，现在结合代码，对其做一个二次梳理，加深理解。</p> <h3 id="intersectionobserver"><a href="#intersectionobserver" class="header-anchor">#</a> IntersectionObserver</h3> <h4 id="定义解释"><a href="#定义解释" class="header-anchor">#</a> 定义解释</h4> <blockquote><p>IntersectionObserver接口 (从属于Intersection Observer API) 提供了一种异步观察目标元素与其祖先元素或顶级文档视窗(viewport)交叉状态的方法。祖先元素与视窗(viewport)被称为根(root)。</p></blockquote> <blockquote><p>当一个IntersectionObserver对象被创建时，其被配置为监听根中一段给定比例的可见区域。一旦IntersectionObserver被创建，则无法更改其配置，所以一个给定的观察者对象只能用来监听可见区域的特定变化值；然而，你可以在同一个观察者对象中配置监听多个目标元素。</p></blockquote> <blockquote><p>创建一个新的IntersectionObserver对象，当其监听到目标元素的可见部分穿过了一个或多个阈(thresholds)时，会执行指定的回调函数。</p></blockquote> <p>IntersectionObserver.observe()使IntersectionObserver开始监听一个目标元素</p> <p>IntersectionObserver.unobserve()使IntersectionObserver停止监听特定目标元素</p> <p>v-seen指令添加到lazy-load的图片标签上；
v-seen指令inserted的回调函数的内容是：1.当元素处于页面相交（曝光）的区域时记录元素开始曝光时间 ，2.当图片loaded时去计算每个图片的loadedTime,并保留所有图片中加载的最大值；3.页面load后对所有lazyload的图片元素添加observe（为什么是这个时机）
用IntersectionObserver监听body根元素里面的所有图片元素，当他们在可视区域（isIntersecting）的时候就执行回调，执行完回调后，删除observe(即停止监听特定目标元素)</p> <p>获取出首屏绘制时的所有图片组件，然后统计首屏的图片组件完成图片加载的时间点作为含图片加载页面首屏时长以此计算含图片加载的页面秒开率</p> <p>目前有一个新的 IntersectionObserver API，可以自动&quot;观察&quot;元素是否可见，Chrome 51+ 已经支持。由于可见（visible）的本质是，目标元素与视口产生一个交叉区，所以这个 API 叫做&quot;交叉观察器&quot;</p> <h4 id="如何判断元素是否在首屏内"><a href="#如何判断元素是否在首屏内" class="header-anchor">#</a> 如何判断元素是否在首屏内？</h4> <p>document.querySelector('body') 如果对body设置了高度100%，那body的高度就是视窗的高度（即首屏的高度），否则就是文档的高度（即包含滚动条的高度）
可以根据这个来判断元素是否在首屏内</p> <h3 id="performanceobserver"><a href="#performanceobserver" class="header-anchor">#</a> PerformanceObserver</h3> <h4 id="定义解释-2"><a href="#定义解释-2" class="header-anchor">#</a> 定义解释</h4> <blockquote><p>PerformanceObserver 用于监测性能度量事件，在浏览器的性能时间轴记录下一个新的 performance entries  的时候将会被通知 。</p></blockquote> <p>PerformanceObserver.observe()指定监测的 entry types 的集合。 当 performance entry 被记录并且是指定的 entryTypes 之一的时候，性能观察者对象的回调函数会被调用。</p> <p>资源的性能数据上报
性能插件install时，就添加资源（图片+接口请求）的观察者；
异步等到页面load后对资源（图片+接口请求）添加性能observe（为什么是这个时机）
记录图片和接口加载的时间并完成上报
Performance
页面性能数据上报
使用performace API,拿到fp,fcp时间，同时用首屏图片加载的最大时间(currentTime - navigationStart)作为fmp时间并上报</p> <p>PerformanceTiming.navigationStart 是一个返回代表一个时刻的 unsigned long long 型只读属性，为紧接着在相同的浏览环境下卸载前一个文档结束之时的 Unix毫秒时间戳。如果没有上一个文档，则它的值相当于 PerformanceTiming.fetchStart。</p> <h3 id="图片懒加载-当图片滚动到可见时才进行加载"><a href="#图片懒加载-当图片滚动到可见时才进行加载" class="header-anchor">#</a> 图片懒加载——当图片滚动到可见时才进行加载</h3> <p>图片懒加载和页面的load事件的关系。</p> <p>load事件
当整个页面及所有依赖资源如样式表和图片都已完成加载时，将触发load事件。</p> <p>它与DOMContentLoaded不同，后者只要页面DOM加载完成就触发，无需等待依赖资源的加载。</p> <p>为啥对图片加载的observe需要放在pageload事件之后呢？</p> <h3 id="性能指标详细说明"><a href="#性能指标详细说明" class="header-anchor">#</a> 性能指标详细说明</h3> <p>对各个指标做一个说明，同时附上阿里云上查询数据的sql，便于理解数据。</p> <h4 id="_1-首字节时间-t-ttfb-自行上报-web-track-performance"><a href="#_1-首字节时间-t-ttfb-自行上报-web-track-performance" class="header-anchor">#</a> 1.首字节时间(t_ttfb)-自行上报（/web-track/performance）</h4> <p>发起页面请求，到浏览器接收到HTML文档的第一个字节</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT approx_percentile(t_ttfb, 0.90) as tp90_time from (select * from log where project = 'tutor-lesson' and t_ttfb &gt; 0)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2-首次渲染时间-t-fp-自行上报-web-track-performance"><a href="#_2-首次渲染时间-t-fp-自行上报-web-track-performance" class="header-anchor">#</a> 2.首次渲染时间(t_fp)-自行上报（/web-track/performance）</h4> <p>它代表网页的第一个像素渲染到屏幕上所用时间，也就是页面在屏幕上首次发生视觉变化的时间；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>project: tutor-lesson and event: '/web-track/performance' and t_fp &gt; 0 | SELECT approx_percentile(t_fp, 0.90) as p90_time
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3-dom-ready时间-t-dom-webtrack统一上报"><a href="#_3-dom-ready时间-t-dom-webtrack统一上报" class="header-anchor">#</a> 3.dom ready时间（t_dom）-webTrack统一上报</h4> <p>完成html的加载及解析工作，加载head及body中的js&amp;css静态文件，构建DOM及CSSOM，合并成渲染树</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>and project:video-template and event:/web-track/performance and t_dom&gt;0 | SELECT approx_percentile(t_dom, 0.90) as p90_time
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4-页面完全加载时间-t-onload-webtrack统一上报"><a href="#_4-页面完全加载时间-t-onload-webtrack统一上报" class="header-anchor">#</a> 4.页面完全加载时间（t_onload）-webTrack统一上报</h4> <p>页面布局及绘制完成，开始加载异步资源，同时也会下载字体、图片等远程资源，加载完成后触发浏览器的onload事件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>project:tutor-lesson and event:/web-track/performance and t_onload&gt;0 | SELECT approx_percentile(t_onload, 0.90) as p90_time
使用的是：performance.timing
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>timing.loadEventEnd - timing.navigationStart</p> <p>这里可以通过优化图片加载的时间来提升页面完全加载的时间。</p> <h4 id="_5-首屏请求p90时间-t-load-自行上报-duration时间"><a href="#_5-首屏请求p90时间-t-load-自行上报-duration时间" class="header-anchor">#</a> 5.首屏请求p90时间（t_load）-自行上报（duration时间）</h4> <p>首屏请求90分位值的时间</p> <p>PerformanceObserver中的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>a.initiatorType === 'xmlhttprequest' &amp;&amp; new RegExp('/leo-midas(.*)/api/').test(a.name)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>duration 时间</p> <h4 id="_6-fmp时间-t-fmp-自行上报-web-track-performance"><a href="#_6-fmp时间-t-fmp-自行上报-web-track-performance" class="header-anchor">#</a> 6.FMP时间(t_fmp)-自行上报（/web-track/performance）</h4> <p>异步资源及接口信息返回后对资源进行更新，dom结构达到稳定状态后记录为首屏时间</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>project: tutor-lesson and event: '/web-track/performance' | SELECT approx_percentile(t_fmp, 0.90) as p90_time
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_7-页面秒开率-t-fmp-1000ms-自行上报-web-track-performance"><a href="#_7-页面秒开率-t-fmp-1000ms-自行上报-web-track-performance" class="header-anchor">#</a> 7.页面秒开率(t_fmp&lt;1000ms)-自行上报（/web-track/performance）</h4> <p>fmp时间小于1s的占比</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT round((direct_count * 100.00 / pv), 2) as direct_rate from (select COUNT(*) as pv, count_if(t_fmp &lt; 1000) as direct_count from log where  project = 'tutor-lesson' and event = '/web-track/performance' and t_fmp &gt; 0 )
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_8-图片直出率-t-load-30ms-自行上报-imgseentoloaded"><a href="#_8-图片直出率-t-load-30ms-自行上报-imgseentoloaded" class="header-anchor">#</a> 8.图片直出率(t_load&lt;30ms)-自行上报（imgSeenToLoaded）</h4> <p>load完成-开始曝光 的时间&lt;30ms</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SELECT round((direct_count *100.0 / pv), 2) as direct_rate from (select COUNT(1) as pv, count_if(t_load &lt; 30) as direct_count from log where project = 'video-template' and event = 'imgSeenToLoaded')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">8/13/2021, 4:27:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/move-forward/mynote/如何解决定时器时间不准的问题.html" class="prev">
        如何解决定时器时间不准的问题
      </a></span> <span class="next"><a href="/move-forward/performance/图片性能优化.html">
        图片性能优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/move-forward/assets/js/app.74813945.js" defer></script><script src="/move-forward/assets/js/2.613a331e.js" defer></script><script src="/move-forward/assets/js/37.0917cb31.js" defer></script>
  </body>
</html>
